box: milcom/centos7-systemd
no-response-timeout: 15
# This is the build pipeline. Pipelines are the core of wercker
# Read more about pipelines on our dev center
# http://devcenter.wercker.com/docs/pipelines/index.html
build:
    # Steps make up the actions in your pipeline
    # Read more about steps on our dev center:
    # http://devcenter.wercker.com/docs/steps/index.html
  steps:
    - script:
        name: setup
        code: |
          yum install epel-release sudo -y
          #yum install python-pip python-devel gcc -y
          #pip install ansible==1.9.4
          yum install -y ansible
          yum clean all 
          sudo sed -i 's/requiretty/!requiretty/g' /etc/sudoers
          free -m
          lscpu

    - script:
         name: deploy
         code: |
           echo "[defaults]" > ansible.cfg
           echo "roles_path = ../" >> ansible.cfg
           cd ..
           mv source openstack-keystone
           cd openstack-keystone

           # launch playbooks
           ansible-playbook -i tests/inventory_local tests/test.yml --syntax-check
           ansible-playbook -i tests/inventory_local tests/test.yml --connection=local --sudo
           ansible-playbook -i tests/inventory_local tests/test.yml --connection=local \
             --sudo | grep -q 'changed=0.*failed=0' \
            && (echo 'Idempotence test: pass' && exit 0) \
            || (echo 'Idempotence test: fail' && exit 1)
           # restore tree
           cd .. && mv openstack-keystone source
           cd source

